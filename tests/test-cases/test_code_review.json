{
  "name": "Review PR - Add Caching Layer",
  "task": "Review this PR and provide feedback",
  "without_context": "Review this PR diff for adding a caching layer:\n\n```diff\n--- a/src/services/ProductService.ts\n+++ b/src/services/ProductService.ts\n@@ -1,10 +1,25 @@\n+import NodeCache from 'node-cache';\n+\n+const cache = new NodeCache({ stdTTL: 3600 });\n+\n export class ProductService {\n   private db: Database;\n \n   async getProduct(id: string): Promise<Product> {\n+    const cached = cache.get<Product>(id);\n+    if (cached) return cached;\n     const product = await this.db.products.findById(id);\n+    cache.set(id, product);\n     return product;\n   }\n \n+  async updateProduct(id: string, data: Partial<Product>): Promise<Product> {\n+    const updated = await this.db.products.update(id, data);\n+    cache.del(id);\n+    return updated;\n+  }\n+\n   async listProducts(category: string): Promise<Product[]> {\n     return this.db.products.findByCategory(category);\n   }\n }\n```\n\nProvide feedback on this code change.",
  "with_context": "## Task\nReview this PR and provide feedback.\n\n## PR Details\n- **PR #342:** Add caching layer to ProductService\n- **Author:** Junior Dev (Alex, 3 months on team)\n- **Branch:** feature/product-cache → main\n- **Reviewers:** You\n- **Linked issue:** PERF-89 (Product page load time >3s)\n\n## Diff\n```diff\n--- a/src/services/ProductService.ts\n+++ b/src/services/ProductService.ts\n@@ -1,10 +1,25 @@\n+import NodeCache from 'node-cache';\n+\n+const cache = new NodeCache({ stdTTL: 3600 });\n+\n export class ProductService {\n   private db: Database;\n \n   async getProduct(id: string): Promise<Product> {\n+    const cached = cache.get<Product>(id);\n+    if (cached) return cached;\n     const product = await this.db.products.findById(id);\n+    cache.set(id, product);\n     return product;\n   }\n \n+  async updateProduct(id: string, data: Partial<Product>): Promise<Product> {\n+    const updated = await this.db.products.update(id, data);\n+    cache.del(id);\n+    return updated;\n+  }\n+\n   async listProducts(category: string): Promise<Product[]> {\n     return this.db.products.findByCategory(category);\n   }\n }\n```\n\n## Team Coding Standards (from STANDARDS.md)\n- No module-level singletons — use dependency injection for all services\n- All caching must go through the CacheManager abstraction (src/infra/CacheManager.ts)\n- Cache keys must be namespaced: `{service}:{entity}:{id}`\n- TTL must be configurable via environment variables\n- All services must be stateless for horizontal scaling (we run 4+ pods)\n\n## ADR-012: Caching Strategy\n- Decided: Use Redis via CacheManager for all caching (not in-process)\n- Reason: We run multiple pods; in-process cache causes stale data across instances\n- CacheManager handles: namespacing, TTL config, serialization, metrics\n\n## Existing CacheManager Interface\n```typescript\n// src/infra/CacheManager.ts\nexport interface CacheManager {\n  get<T>(namespace: string, key: string): Promise<T | null>;\n  set<T>(namespace: string, key: string, value: T, ttlSeconds?: number): Promise<void>;\n  delete(namespace: string, key: string): Promise<void>;\n  invalidateNamespace(namespace: string): Promise<void>;\n}\n```\n\n## Architecture Context\n- 4 pods behind load balancer\n- Product updates come from: admin UI, bulk import service, inventory sync\n- Bulk import service calls db directly (doesn't go through ProductService)\n- Average 12K product reads/min, 50 writes/min\n- Current p99 latency: 3.2s (target: <500ms)\n\n## Related Recent Incident (INC-445)\n- Last month: UserService had same pattern (in-process cache)\n- Result: Users saw stale profile data for up to 1 hour\n- Fix: Migrated to CacheManager + Redis\n- Post-mortem action item: \"All new caching must use CacheManager\"",
  "evaluation_criteria": [
    "flags module-level singleton as standards violation",
    "recommends CacheManager instead of NodeCache (per ADR-012)",
    "warns about multi-pod stale data problem",
    "mentions bulk import service bypassing cache invalidation",
    "references INC-445 as precedent",
    "suggests namespaced cache keys per standards",
    "tone is constructive (author is junior dev)"
  ]
}
